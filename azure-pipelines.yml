variables:
  AzureConnection: 'BiomedicalImaging-NonProd(87d8acb3-5176-4651-b457-6ab9cefd8e3d)'
  imageBaseName: 'ghcr.io/gadgetron/gadgetron/gadgetron_ubuntu'
  DOCKER_BUILDKIT: 1
  isPR: $[eq(variables['Build.Reason'], 'PullRequest')]
  isCI: $[or(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.Reason'], 'BatchedCI'))]


# Trigger when merging to master
trigger:
- master

# Trigger for PRs that merge to master
pr:
- master

jobs:
- job: buildAndTestMacOS
  pool:
    name: Azure Pipelines
    vmImage: macOS-latest
  timeoutInMinutes: 120
  displayName: "Building on macOS (not testing yet)"
  steps:
  - task: AzureKeyVault@2
    inputs:
      azureSubscription: $(AzureConnection)
      keyVaultName: gadgetron-build-secrets
  - script: |
      eval "$(conda shell.bash hook)"
      wget https://repo.anaconda.com/miniconda/Miniconda3-latest-MacOSX-x86_64.sh -O ~/miniconda.sh \
         && mkdir -p ~/conda \
         && bash ~/miniconda.sh -b -p ~/conda \
         && source ~/conda/bin/activate \
         && conda init zsh
      conda env create -f environment-macos.yml
      conda activate gadgetron
      set -euo pipefail
      cd conda && ./package.sh
    displayName: "Building Gadgetron on macOS"
