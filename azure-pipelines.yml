variables:
  AzureConnection: 'BiomedicalImaging-NonProd(87d8acb3-5176-4651-b457-6ab9cefd8e3d)'
  imageBaseName: 'ghcr.io/gadgetron/gadgetron/gadgetron_ubuntu'
  DOCKER_BUILDKIT: 1
  isPR: $[eq(variables['Build.Reason'], 'PullRequest')]
  isCI: $[or(eq(variables['Build.Reason'], 'IndividualCI'), eq(variables['Build.Reason'], 'BatchedCI'))]


# Trigger when merging to master
trigger:
- master

# Trigger for PRs that merge to master
pr:
- master

jobs:
- job: BuildAndTest
  pool: gadgetron-gpu-nodes
  timeoutInMinutes: 120
  displayName: "Build, Unit and Integration tests"
  strategy:
    matrix:
      cuda:
        flavor: cuda
        requirements: python,cuda
      nocuda:
        flavor: nocuda
        requirements: python
  steps:
  - task: AzureKeyVault@1
    inputs:
      azureSubscription: $(AzureConnection)
      keyVaultName: gadgetron-build-secrets
  - script: |
        set -e
        uname -a
    displayName: "ID base machine"
    condition: and(succeeded(), eq(variables.isCI, 'true'))
- job: build-and-test-macOS
  pool: macOS-latest
  timeoutInMinutes: 120
  displayName: "Build, test on macOS"
  strategy:
    matrix:
      nocuda:
        flavor: nocuda
        requirements: python
  steps:
  - task: AzureKeyVault@1
    inputs:
      azureSubscription: $(AzureConnection)
      keyVaultName: gadgetron-build-secrets
  - script: |
        set -e
        uname -a
        which curl
        which wget
    displayName: "Check for basic utilities"
    condition: and(succeeded(), eq(variables.isCI, 'true'))
