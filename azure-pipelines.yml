# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool: gadgetron-gpu-nodes

steps:

- script: |
      IMAGE_NAME_CUDA=gadgetron_ubuntu_2004_cuda11_cudnn8
      IMAGE_NAME=gadgetron_ubuntu_2004
      echo "PR Source Repo URL: $(System.PullRequest.SourceRepositoryURI)"
      echo "PR Source Branch: $(System.PullRequest.SourceBranch)"
      cd docker
      docker build . --file ubuntu_2004_cuda11_cudnn.Dockerfile --tag $IMAGE_NAME_CUDA --build-arg GADGETRON_URL=$(System.PullRequest.SourceRepositoryURI)	 --build-arg GADGETRON_BRANCH=$(System.PullRequest.SourceBranch)
      docker run --rm $IMAGE_NAME_CUDA /opt/gadgetron/build/test/test_all
      docker build . --file ubuntu_2004.Dockerfile --tag $IMAGE_NAME --build-arg GADGETRON_URL=$(System.PullRequest.SourceRepositoryURI) --build-arg GADGETRON_BRANCH=$(System.PullRequest.SourceBranch)
      docker run --rm $IMAGE_NAME /opt/gadgetron/build/test/test_all
  displayName: 'Build docker and test images'
