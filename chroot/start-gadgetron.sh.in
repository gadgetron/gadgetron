#!/bin/bash

gadgetron_job=0
trap '(($gadgetron_job == 0)) || ((`kill -0 $gadgetron_job`))|| kill $gadgetron_job' HUP TERM INT

if [ $# -ge 1 ]; then
    LOG_FILE=${1}
    PORT=9002

    if [ $# -eq 2 ]; then
        PORT=${2}
    fi

    OMP_THREAD_LIMIT=$(nproc)
    OMP_WAIT_POLICY=PASSIVE
    GADGETRON_ISMRMRD_DUMP=OFF
    PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:@CMAKE_INSTALL_PREFIX@/bin LD_LIBRARY_PATH=/usr/local/lib:@CMAKE_INSTALL_PREFIX@/lib:/opt/intel/mkl/lib/intel64:/opt/intel/lib/intel64 LC_ALL=C GTBABYLON_PUBLIC_KEY=/opt/key/gtbabylon-key.public GADGETRON_ISMRMRD_DUMP=OFF @CMAKE_INSTALL_PREFIX@/bin/gadgetron -p ${PORT} > ${LOG_FILE} &

    gadgetron_job=($!)
    wait $!
    exit 0
else
    echo -e "\nUsage: $0 (log file in chroot) (gadgetron port)\n"
    exit 1
fi
