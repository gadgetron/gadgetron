parameters:
- name: azureconnection
  type: string
- name: dockerfile
  type: string
- name: imagename
  type: string
- name: imagetag
  type: string
- name: containerregistry
  type: string

steps:
- task: AzureKeyVault@1
  inputs:
    azureSubscription: ${{ parameters.azureconnection }}
    keyVaultName: gadgetron-build-secrets

- script: |
      fullImageName="${{ parameters.containerregistry }}/${{ parameters.imagename }}/${{ parameters.imagetag }}"
      echo "Building image ${fullImageName}"
      docker build . --file ${{ parameters.dockerfile }} --tag $fullImageName
      docker run --rm $fullImageName /opt/code/gadgetron/build/test/test_all
  displayName: 'Build docker and test images'