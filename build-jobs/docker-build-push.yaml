parameters:
- name: azureconnection
  type: string
- name: dockerfile
  type: string
- name: imagename
  type: string
- name: imagetag
  type: string
- name: containerregistry
  type: string

steps:
- task: AzureKeyVault@1
  inputs:
    azureSubscription: ${{ parameters.azureconnection }}
    keyVaultName: gadgetron-build-secrets

- script: |
      # Exit if anything fails
      set -e
      fullImageName="${{ parameters.containerregistry }}/${{ parameters.imagename }}:${{ parameters.imagetag }}"
      echo "Building image ${fullImageName}"
      docker build . --file ${{ parameters.dockerfile }} --tag $fullImageName
      docker run --gpus all --rm $fullImageName /opt/code/gadgetron/build/test/test_all
      echo "$(ghcr-pat)" | docker login ghcr.io -u $(ghcr-user) --password-stdin
      docker push $fullImageName

  displayName: 'Build docker and test images'